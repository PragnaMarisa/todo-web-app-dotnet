@using todo_web_app_dotnet.Models
@using todo_web_app_dotnet.ViewModels
@model AllTodosViewModel

<!DOCTYPE html>
<html>
<head>
    <title>Todo Groups</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/alltodos.css" asp-append-version="true" />
</head>
<body>
    <header class="topbar">
        <div class="topbar-inner">
            <div class="topbar-brand">
                Task Master
            </div>
            <nav class="topbar-nav">
                <a href="@Url.Action("Index", "Todos")"
                   class="topbar-link topbar-link--primary">
                    Home
                </a>
            </nav>
        </div>
    </header>
    <div class="container">
        <div class="header">
            <h1>‚ú® Task Master</h1>
            <p>Track, organize, and conquer your goals with style</p>
        </div>

        <!-- Add New Todo Section -->
        <div class="add-todo-section">
            <h2>‚ûï Create New Task Group</h2>
            <form method="post" action="@Url.Action("AddTodo", "Todos")">
                <div class="form-row">
                    <div>
                        <div class="form-group">
                            <label for="todoTitle">Group Title <span style="color: #d32f2f;">*</span></label>
                            <input type="text" id="todoTitle" name="title" placeholder="e.g., Project Setup, Backend Development..." required />
                        </div>
                        <div class="form-group">
                            <label for="todoDescription">Description</label>
                            <textarea id="todoDescription" name="description" placeholder="Describe what this group of tasks is about (optional)"></textarea>
                        </div>
                    </div>
                </div>
                <button type="submit" class="submit-btn">Create Group</button>
            </form>
        </div>

        @if (Model != null && Model.Groups.Count > 0)
        {
            <div class="todo-groups">
                @foreach (var todo in Model.Groups)
                {
                    var todoId = todo.Id;
                    var tasks = todo.Tasks ?? new List<Todotask>();
                    var totalTasks = todo.TotalTasks;
                    var completedTasks = todo.CompletedTasks;
                    var progressPercentage = todo.ProgressPercentage;

                    var groupEmojis = new Dictionary<int, string> 
                    { 
                        { 1, "üöÄ" },
                        { 2, "‚öôÔ∏è" },
                        { 3, "üé®" },
                        { 4, "üìä" },
                        { 5, "üîß" }
                    };
                    var emoji = groupEmojis.ContainsKey(todoId) ? groupEmojis[todoId] : "üìù";

                    <div class="todo-group" data-todo-id="@todoId">
                        <div class="group-header">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <div class="group-title">@emoji @(todo.Title ?? "")</div>
                                    <div class="group-description">@(todo.Description ?? "")</div>
                                    <div class="group-stats" data-role="group-stats">‚ú® @completedTasks / @totalTasks tasks completed</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" data-role="progress-fill" style="width: @progressPercentage%"></div>
                                    </div>
                                </div>
                                <form method="post" action="@Url.Action("DeleteTodo", "Todos")" style="display: inline;">
                                    <input type="hidden" name="id" value="@todoId" />
                                    <button type="button" class="delete-group-btn delete-group-btn-js" title="Delete Group">üóëÔ∏è</button>
                                </form>
                            </div>
                        </div>

                        <!-- Add Task Form - Above Tasks -->
                        <div class="add-task-section">
                            <h3>‚ú® Add New Task</h3>
                            <form method="post" action="@Url.Action("AddTask", "Todos")" class="add-task-form" data-todo-id="@todoId">
                                <input type="hidden" name="todoId" value="@todoId" />
                                <input type="text" name="title" placeholder="üí° Task title..." required enterkeyhint="go" />
                                <button type="submit" class="add-task-btn">‚ûï Add</button>
                                <textarea name="description" placeholder="üìù Task description (optional)..." style="grid-column: 1 / -1;"></textarea>
                            </form>
                        </div>

                        @if (totalTasks > 0)
                        {
                            <div class="tasks-container">
                                <!-- Pending Tasks -->
                                @foreach (var task in tasks.Where(t => !t.IsCompleted))
                                {
                                    <div class="task-item @(task.IsCompleted ? "completed" : "")">
                                        <form method="post" action="@Url.Action("ToggleStatus", "Todos")" style="display: inline;">
                                            <input type="hidden" name="id" value="@todoId" />
                                            <input type="hidden" name="taskId" value="@task.Id" />
                                            <input type="checkbox" class="task-checkbox toggle-checkbox" @(task.IsCompleted ? "checked" : "") />
                                        </form>
                                        <div class="task-content">
                                            <div class="task-title">@task.Title</div>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <div class="task-description">@task.Description</div>
                                            }
                                            <div class="task-date">üìÖ @task.CreatedDate.ToString("MMM dd, yyyy")</div>
                                        </div>
                                        <div class="task-status-badge @(task.IsCompleted ? "completed" : "pending")">
                                            @(task.IsCompleted ? "‚úì Done" : "‚è≥ Pending")
                                        </div>
                                        <div class="task-actions">
                                            <form method="post" action="@Url.Action("DeleteTask", "Todos")" style="display: inline;">
                                                <input type="hidden" name="id" value="@todoId" />
                                                <input type="hidden" name="taskId" value="@task.Id" />
                                                <button type="button" class="delete-btn delete-task-btn" title="Delete task">üóëÔ∏è</button>
                                            </form>
                                        </div>
                                    </div>
                                }
                                
                                <!-- Completed Tasks -->
                                @foreach (var task in tasks.Where(t => t.IsCompleted))
                                {
                                    <div class="task-item @(task.IsCompleted ? "completed" : "")">
                                        <form method="post" action="@Url.Action("ToggleStatus", "Todos")" style="display: inline;">
                                            <input type="hidden" name="id" value="@todoId" />
                                            <input type="hidden" name="taskId" value="@task.Id" />
                                            <input type="checkbox" class="task-checkbox toggle-checkbox" @(task.IsCompleted ? "checked" : "") />
                                        </form>
                                        <div class="task-content">
                                            <div class="task-title">@task.Title</div>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <div class="task-description">@task.Description</div>
                                            }
                                            <div class="task-date">üìÖ @task.CreatedDate.ToString("MMM dd, yyyy")</div>
                                        </div>
                                        <div class="task-status-badge @(task.IsCompleted ? "completed" : "pending")">
                                            @(task.IsCompleted ? "‚úì Done" : "‚è≥ Pending")
                                        </div>
                                        <div class="task-actions">
                                            <form method="post" action="@Url.Action("DeleteTask", "Todos")" style="display: inline;">
                                                <input type="hidden" name="id" value="@todoId" />
                                                <input type="hidden" name="taskId" value="@task.Id" />
                                                <button type="button" class="delete-btn delete-task-btn" title="Delete task">üóëÔ∏è</button>
                                            </form>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="tasks-container">
                                <div class="empty-state">
                                    <p>üåü No tasks yet! Start by adding one above üåü</p>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state-page">
                <h2>üì≠ No Tasks Yet</h2>
                <p>Start by creating your first task group!</p>
            </div>
        }

    </div>

    <script>
        function updateGroupStatsAndProgress(todoGroupEl) {
            if (!todoGroupEl) return;

            const taskItems = todoGroupEl.querySelectorAll('.task-item');
            const total = taskItems.length;
            const completed = todoGroupEl.querySelectorAll('.task-item.completed').length;
            const percent = total > 0 ? Math.round((completed * 100) / total) : 0;

            const stats = todoGroupEl.querySelector('[data-role="group-stats"]');
            if (stats) stats.textContent = `‚ú® ${completed} / ${total} tasks completed`;

            const fill = todoGroupEl.querySelector('[data-role="progress-fill"]');
            if (fill) fill.style.width = `${percent}%`;
        }

        function moveTaskBetweenSections(taskItem) {
            const todoGroupEl = taskItem?.closest('.todo-group');
            if (!todoGroupEl) return;

            const tasksContainer = todoGroupEl.querySelector('.tasks-container');
            if (!tasksContainer) return;

            const isCompleted = taskItem.classList.contains('completed');
            const firstCompleted = tasksContainer.querySelector('.task-item.completed');
            const firstPending = tasksContainer.querySelector('.task-item:not(.completed)');

            if (isCompleted) {
                // Place at the top of completed section (after the pending list)
                if (firstCompleted) {
                    firstCompleted.insertAdjacentElement('beforebegin', taskItem);
                } else {
                    tasksContainer.appendChild(taskItem);
                }
            } else {
                // Place at the end of pending section (before first completed)
                if (firstCompleted) {
                    firstCompleted.insertAdjacentElement('beforebegin', taskItem);
                } else if (firstPending) {
                    firstPending.insertAdjacentElement('beforebegin', taskItem);
                } else {
                    tasksContainer.appendChild(taskItem);
                }
            }
        }

        // Handle add task with AJAX
        document.querySelectorAll('.add-task-form').forEach(form => {
            const titleInput = form.querySelector('input[name="title"]');
            if (titleInput) {
                titleInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        form.requestSubmit();
                    }
                });
            }
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const title = this.querySelector('input[name="title"]').value;

                if (!title.trim()) return;

                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // Clear form inputs and refresh to sync IDs/state from server
                        this.querySelector('input[name="title"]').value = '';
                        this.querySelector('textarea[name="description"]').value = '';
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Error adding task:', error);
                    alert('Error adding task. Please try again.');
                }
            });
        });

        // Function to attach event listeners to task elements
        function attachTaskEventListeners() {
            // Attach toggle listeners
            document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                checkbox.removeEventListener('change', toggleTaskHandler);
                checkbox.addEventListener('change', toggleTaskHandler);
            });
            
            // Attach delete listeners
            document.querySelectorAll('.delete-task-btn').forEach(btn => {
                btn.removeEventListener('click', deleteTaskHandler);
                btn.addEventListener('click', deleteTaskHandler);
            });

            // Attach delete group listeners
            document.querySelectorAll('.delete-group-btn-js').forEach(btn => {
                btn.removeEventListener('click', deleteGroupHandler);
                btn.addEventListener('click', deleteGroupHandler);
            });
        }

        // Toggle task handler
        async function toggleTaskHandler(e) {
            const checkbox = this;
            const currentState = checkbox.checked;
            
            const form = checkbox.closest('form');
            const todoId = form.querySelector('input[name="id"]').value;
            const taskId = form.querySelector('input[name="taskId"]').value;
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        id: todoId,
                        taskId: taskId
                    })
                });
                
                if (response.ok) {
                    const taskItem = checkbox.closest('.task-item');
                    const wasCompleted = taskItem.classList.contains('completed');
                    const isNowCompleted = !wasCompleted;
                    
                    taskItem.classList.toggle('completed');
                    
                    // Update status badge with proper class management
                    const badge = taskItem.querySelector('.task-status-badge');
                    if (badge) {
                        if (isNowCompleted) {
                            badge.classList.remove('pending');
                            badge.classList.add('completed');
                            badge.textContent = '‚úì Done';
                        } else {
                            badge.classList.remove('completed');
                            badge.classList.add('pending');
                            badge.textContent = '‚è≥ Pending';
                        }
                    }

                    moveTaskBetweenSections(taskItem);
                    updateGroupStatsAndProgress(taskItem.closest('.todo-group'));
                } else {
                    // Revert checkbox if request failed
                    checkbox.checked = !currentState;
                }
            } catch (error) {
                console.error('Error toggling task:', error);
                // Revert checkbox if request failed
                checkbox.checked = !currentState;
            }
        }

        // Delete task handler
        async function deleteTaskHandler(e) {
            e.preventDefault();
            
            const btn = this;
            const form = btn.closest('form');
            const todoId = form.querySelector('input[name="id"]').value;
            const taskId = form.querySelector('input[name="taskId"]').value;
            
            // Show confirmation popup at cursor
            showDeleteConfirmation(e, async (confirmed) => {
                if (!confirmed) return;
                
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            id: todoId,
                            taskId: taskId
                        })
                    });
                    
                    if (response.ok) {
                        const taskItem = btn.closest('.task-item');
                        taskItem.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            const group = taskItem.closest('.todo-group');
                            taskItem.remove();
                            updateGroupStatsAndProgress(group);
                        }, 300);
                        
                        // Show success notification
                        showNotification('Task deleted successfully', e.clientX, e.clientY);
                    }
                } catch (error) {
                    console.error('Error deleting task:', error);
                }
            });
        }

        // Delete group (todo) handler - same UX as delete task
        async function deleteGroupHandler(e) {
            e.preventDefault();

            const btn = this;
            const form = btn.closest('form');
            const todoId = form.querySelector('input[name="id"]').value;

            showDeleteConfirmation(e, async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            id: todoId
                        })
                    });

                    if (response.ok) {
                        const groupEl = btn.closest('.todo-group');
                        groupEl.style.animation = 'fadeOut 0.3s ease-out forwards';

                        setTimeout(() => {
                            groupEl.remove();

                            // If no groups left, show empty state (without full reload)
                            if (document.querySelectorAll('.todo-group').length === 0) {
                                const container = document.querySelector('.container');
                                const existingGroups = container?.querySelector('.todo-groups');
                                if (existingGroups) existingGroups.remove();

                                const empty = document.createElement('div');
                                empty.style.textAlign = 'center';
                                empty.style.padding = '80px 20px';
                                empty.style.color = 'white';
                                empty.innerHTML = `
                                    <h2 style="font-size: 2em; margin-bottom: 20px;">üì≠ No Tasks Yet</h2>
                                    <p style="font-size: 1.1em; opacity: 0.9;">Start by creating your first task group!</p>
                                `;
                                container?.appendChild(empty);
                            }
                        }, 300);

                        showNotification('Group deleted successfully', e.clientX, e.clientY);
                    }
                } catch (error) {
                    console.error('Error deleting group:', error);
                }
            }, 'Delete this group?');
        }

        // Show delete confirmation popup
        function showDeleteConfirmation(event, callback, message = 'Delete this task?') {
            const popup = document.createElement('div');
            popup.className = 'delete-confirm-popup';
            popup.innerHTML = `
                <div class="delete-confirm-content">
                    <p>${message}</p>
                    <div class="delete-confirm-buttons">
                        <button class="confirm-yes">Yes</button>
                        <button class="confirm-no">No</button>
                    </div>
                </div>
            `;
            
            popup.style.left = (event.clientX + 10) + 'px';
            popup.style.top = (event.clientY + 10) + 'px';
            
            document.body.appendChild(popup);
            
            const yesBtn = popup.querySelector('.confirm-yes');
            const noBtn = popup.querySelector('.confirm-no');
            
            yesBtn.addEventListener('click', () => {
                popup.remove();
                callback(true);
            });
            
            noBtn.addEventListener('click', () => {
                popup.remove();
                callback(false);
            });
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && popup.parentNode) {
                        popup.remove();
                        document.removeEventListener('click', closePopup);
                        callback(false);
                    }
                });
            }, 0);
        }

        // Show notification popup
        function showNotification(message, x, y) {
            const notification = document.createElement('div');
            notification.className = 'delete-notification';
            notification.textContent = message;
            
            notification.style.right = '20px';
            notification.style.top = '20px';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Initial attachment of event listeners
        attachTaskEventListeners();

        // Ensure stats/progress are correct on load (in case DOM differs from server render)
        document.querySelectorAll('.todo-group').forEach(updateGroupStatsAndProgress);

        // Add fadeOut animation
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(-100%);
                }
            }
        `;
        document.head.appendChild(style);
    </script>

    <footer class="site-footer">
        <div class="site-footer-inner">
            <div>¬© @DateTime.Now.Year Task Master</div>
            <div class="site-footer-muted">Built with ASP.NET Core MVC</div>
        </div>
    </footer>
</body>
</html>
